name: Publish

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬å‘å¸ƒç±»å‹'
        required: true
        default: 'Patch'
        type: choice
        options:
          - Patch
          - Minor
          - Major
      changelog:
        description: 'æ›´æ–°æ—¥å¿—ï¼ˆå­æ’ä»¶å£¹ï¼šæ›´æ–°å†…å®¹|å­æ’ä»¶è´°ï¼šæ›´æ–°å†…å®¹ï¼‰'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    name: ğŸš€ è‡ªåŠ¨åŒ–æ„å»º
    environment:
      name: Publish
      url: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.calculate_version.outputs.new_version }}

    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pip dependencies
        run: |
          pip3 install semver luadata

      - name: Install apt dependencies
        run: |
          sudo rm -f /var/lib/man-db/auto-update
          sudo apt install --no-install-recommends lua5.1 p7zip-full

      - name: Set up Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Switch and hard reset to master
        run: |
          git fetch origin
          git checkout master
          git reset --hard origin/master

      - name: Calculate new version
        id: calculate_version
        run: |
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          CURRENT_VERSION=$(grep "_VERSION_.*'.*'" MY_!Base/src/lib/Base.lua | sed -E "s/.*'(.*)'.*/\1/")

          # éªŒè¯å½“å‰ç‰ˆæœ¬æ ¼å¼
          if ! echo "$CURRENT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Current version format is invalid: $CURRENT_VERSION. Expected format: X.Y.Z"
            exit 1
          fi

          # ä½¿ç”¨Pythonè®¡ç®—æ–°ç‰ˆæœ¬å·
          NEW_VERSION=$(python3 -c "
          import semver

          current = '$CURRENT_VERSION'
          version_type = '$VERSION_TYPE'.lower()  # è½¬æ¢ä¸ºå°å†™

          try:
            if version_type == 'patch':
              new_version = semver.bump_patch(current)
            elif version_type == 'minor':
              new_version = semver.bump_minor(current)
            elif version_type == 'major':
              new_version = semver.bump_major(current)
            else:
              raise ValueError(f'Invalid version type: {version_type}')

            print(new_version)
          except Exception as e:
            print(f'Error calculating new version: {e}', file=sys.stderr)
            exit(1)
          ")

          echo "Current version: $CURRENT_VERSION"
          echo "Version type: $VERSION_TYPE"
          echo "New version: $NEW_VERSION"

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Base.lua version and build
        run: |
          DATE=$(date +%Y%m%d)
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          sed -i "s/\(local _BUILD_\)\( *\)\(=\) *'[^']*'/\1\2\3 '${DATE}'/" MY_!Base/src/lib/Base.lua
          sed -i "s/\(local _VERSION_\)\( *\)\(=\) *'[^']*'/\1\2\3 '${NEW_VERSION}'/" MY_!Base/src/lib/Base.lua

      - name: Update AssertVersion calls in Lua files
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          echo "ğŸ” Updating AssertVersion calls to version: $NEW_VERSION"
          python3 \!src-dist/update_assert_version.py "$NEW_VERSION" --force-changed

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
          if git diff --quiet; then
            echo "âœ… No AssertVersion calls needed to be updated"
          else
            echo "ğŸ“ Some AssertVersion calls have been updated:"
            git diff --name-only
          fi

      - name: Update CHANGELOG.md
        id: update_changelog
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          CHANGELOG="${{ github.event.inputs.changelog }}"
          TMPFILE=$(mktemp)
          echo "# æ›´æ–°æ—¥å¿—" > $TMPFILE
          echo "" >> $TMPFILE

          # æ™ºèƒ½å¤„ç†æ›´æ–°æ—¥å¿—å†…å®¹
          process_changelog() {
            local input="$1"

            # é¦–å…ˆå¤„ç†åŸå§‹æ ¼å¼ * [æ’ä»¶] å†…å®¹ï¼Œåœ¨ * å‰é¢æ·»åŠ åˆ†éš”ç¬¦
            input=$(echo "$input" | sed 's/\([^|]\)\(\*[[:space:]]*\[\)/\1|\2/g')

            # æŒ‰ | åˆ†å‰²æ¯ä¸€è¡Œ
            echo "$input" | tr '|' '\n' | while IFS= read -r line; do
              # å»æ‰é¦–å°¾ç©ºæ ¼
              line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

              # å»æ‰é¦–å°¾å¼•å·
              line=$(echo "$line" | sed 's/^["""]//;s/["""]$//')

              # è·³è¿‡ç©ºè¡Œ
              [ -z "$line" ] && continue

              # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ * [æ’ä»¶] æ ¼å¼
              if echo "$line" | grep -q '^\*[[:space:]]*\['; then
                # å·²ç»æ˜¯æ­£ç¡®æ ¼å¼ï¼Œåªéœ€è¦æ ¼å¼åŒ–ç©ºæ ¼
                plugin=$(echo "$line" | sed 's/^\*[[:space:]]*\[\([^]]*\)\].*/\1/' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                content=$(echo "$line" | sed 's/^\*[[:space:]]*\[[^]]*\][[:space:]]*//')
                echo "* [$plugin] $content"
              else
                # è½¬æ¢ æ’ä»¶:å†…å®¹ æ ¼å¼ä¸º * [æ’ä»¶] å†…å®¹
                if echo "$line" | grep -q '[ï¼š:]'; then
                  plugin=$(echo "$line" | sed 's/\([^ï¼š:]*\)[ï¼š:].*/\1/' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^["""]//;s/["""]$//')
                  content=$(echo "$line" | sed 's/[^ï¼š:]*[ï¼š:][[:space:]]*//' | sed 's/^["""]//;s/["""]$//')
                  echo "* [$plugin] $content"
                else
                  # å¦‚æœæ²¡æœ‰å†’å·ï¼Œå‡è®¾æ•´è¡Œéƒ½æ˜¯å†…å®¹
                  echo "* $line"
                fi
              fi
            done
          }

          # å¤„ç†æ›´æ–°æ—¥å¿—å¹¶ä¿å­˜åˆ°ä¸´æ—¶å˜é‡
          PROCESSED_CHANGELOG="## èŒ—ä¼Šæ’ä»¶é›† v${NEW_VERSION}"$'\n\n'"$(process_changelog "$CHANGELOG")"

          # è¾“å‡ºåˆ° TMPFILE
          echo "$PROCESSED_CHANGELOG" >> $TMPFILE
          echo "" >> $TMPFILE
          tail -n +3 CHANGELOG.md >> $TMPFILE
          mv $TMPFILE CHANGELOG.md

          # è®¾ç½®æ­¥éª¤è¾“å‡ºï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          {
            echo "changelog<<EOF"
            echo "$PROCESSED_CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Write secret to file
        run: |
          cat > secret.jx3dat << 'EOF'
          ${{ secrets.SECRET_JX3DAT }}
          EOF

      - name: Commit release changes
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          git add -A
          git commit -m "release: ${NEW_VERSION}" || echo "No changes to commit"

      - name: Run Build Command
        run: |
          python3 \!src-dist/ci.py

      - name: Create Release Branch
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          BRANCH="release/v${NEW_VERSION}"
          git push -f origin master:stable
          git push -f origin master:$BRANCH

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          title: "release: v${{ steps.calculate_version.outputs.new_version }}"
          body: "Automated release PR for version ${{ steps.calculate_version.outputs.new_version }}"
          base: master
          branch: "release/v${{ steps.calculate_version.outputs.new_version }}"

      - name: Upload Artifacts
        id: upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-archives-${{ github.run_number }}-${{ github.sha }}
          path: '\!src-dist/dist/*.7z'

      - name: Output Summary
        if: steps.create_pr.outputs.pull-request-url
        run: |
          echo "# ğŸ‰ æ„å»ºæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¾“å‡ºæ›´æ–°æ—¥å¿—å†…å®¹
          echo "## ğŸ“ æ›´æ–°æ—¥å¿—å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.update_changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¾“å‡º Pull Request ä¿¡æ¯
          echo "## ğŸ”— Pull Request ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Pull Request å·²åˆ›å»º**: ${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **ç‰ˆæœ¬**: v${{ steps.calculate_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¾“å‡º Artifacts ä¿¡æ¯
          echo "## ğŸ“¦ æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Artifacts åç§°**: \`dist-archives-${{ github.run_number }}-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **ä¸‹è½½é“¾æ¥**: [${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥å¯ä»¥åœ¨ Actions é¡µé¢ä¸­æ‰¾åˆ°å¹¶ä¸‹è½½æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY

          # åŒæ—¶è¾“å‡º notice
          echo "::notice title=ğŸ“ Pull Request å·²ç”Ÿæˆ::Pull Request created: ${{ steps.create_pr.outputs.pull-request-url }}"
